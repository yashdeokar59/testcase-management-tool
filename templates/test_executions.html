{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 fw-bold text-dark mb-1">Test Executions</h1>
        <p class="text-muted">View and manage all test execution history</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
            <i class="fas fa-filter me-2"></i>Filter
        </button>
        <button class="btn btn-outline-success" onclick="exportExecutions()">
            <i class="fas fa-download me-2"></i>Export
        </button>
    </div>
</div>

<!-- Filter Summary -->
<div id="filterSummary" class="alert alert-info" style="display: none;">
    <i class="fas fa-filter me-2"></i>
    <span id="filterText">Filters applied</span>
    <button class="btn btn-sm btn-outline-primary ms-2" onclick="clearFilters()">Clear Filters</button>
</div>

<div class="card">
    <div class="card-body">
        {% if executions %}
        <div class="table-responsive">
            <table class="table table-hover align-middle" id="executionsTable">
                <thead>
                    <tr>
                        <th>Execution ID</th>
                        <th>Test Case</th>
                        <th>Status</th>
                        <th>Executed By</th>
                        <th>Environment</th>
                        <th>Date</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for execution in executions %}
                    <tr data-status="{{ execution.status }}" data-environment="{{ execution.environment or '' }}" data-date="{{ execution.execution_date.strftime('%Y-%m-%d') }}">
                        <td><strong>EXE-{{ execution.id }}</strong></td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-primary bg-opacity-10 rounded-circle p-2 me-3">
                                    <i class="fas fa-vial text-primary"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0">TC-{{ execution.test_case_id }}</h6>
                                    <small class="text-muted">Test Case #{{ execution.test_case_id }}</small>
                                </div>
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-{% if execution.status == 'Pass' %}success{% elif execution.status == 'Fail' %}danger{% elif execution.status == 'Blocked' %}warning{% else %}secondary{% endif %} px-3 py-2">
                                <i class="fas fa-{% if execution.status == 'Pass' %}check{% elif execution.status == 'Fail' %}times{% elif execution.status == 'Blocked' %}exclamation{% else %}clock{% endif %} me-1"></i>
                                {{ execution.status }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="bg-secondary bg-opacity-10 rounded-circle p-1 me-2">
                                    <i class="fas fa-user text-secondary"></i>
                                </div>
                                User #{{ execution.executed_by }}
                            </div>
                        </td>
                        <td>
                            <span class="badge bg-light text-dark">{{ execution.environment or 'Not specified' }}</span>
                        </td>
                        <td>
                            <div>
                                <div class="fw-semibold">{{ execution.execution_date.strftime('%b %d, %Y') }}</div>
                                <small class="text-muted">{{ execution.execution_date.strftime('%H:%M') }}</small>
                            </div>
                        </td>
                        <td>
                            <span class="text-muted">{{ execution.execution_time or 'N/A' }} min</span>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#" onclick="viewDetails({{ execution.id }})">
                                        <i class="fas fa-eye me-2"></i>View Details
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="addComment({{ execution.id }})">
                                        <i class="fas fa-comment me-2"></i>Add Comment
                                    </a></li>
                                    {% if execution.status == 'Fail' %}
                                    <li><a class="dropdown-item" href="#" onclick="createBug({{ execution.id }})">
                                        <i class="fas fa-bug me-2"></i>Create Bug
                                    </a></li>
                                    {% endif %}
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteExecution({{ execution.id }})">
                                        <i class="fas fa-trash me-2"></i>Delete Execution
                                    </a></li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-play fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No test executions found</h5>
            <p class="text-muted">Execute some test cases to see results here</p>
            <a href="{{ url_for('test_cases') }}" class="btn btn-primary">
                <i class="fas fa-play me-2"></i>Execute Tests
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Filter Modal -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Filter Test Executions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="statusFilter">
                            <option value="">All Statuses</option>
                            <option value="Pass">Pass</option>
                            <option value="Fail">Fail</option>
                            <option value="Blocked">Blocked</option>
                            <option value="Not Executed">Not Executed</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Environment</label>
                        <select class="form-select" id="environmentFilter">
                            <option value="">All Environments</option>
                            <option value="Test Environment">Test Environment</option>
                            <option value="Staging">Staging</option>
                            <option value="Production">Production</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">From Date</label>
                                <input type="date" class="form-control" id="fromDate">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">To Date</label>
                                <input type="date" class="form-control" id="toDate">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            </div>
        </div>
    </div>
</div>

<!-- View Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Execution Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detailsContent">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Add Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="commentForm">
                    <input type="hidden" id="executionId">
                    <div class="mb-3">
                        <label class="form-label">Comment</label>
                        <textarea class="form-control" id="commentText" rows="4" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveComment()">Save Comment</button>
            </div>
        </div>
    </div>
</div>

<script>
function applyFilters() {
    const status = document.getElementById('statusFilter').value;
    const environment = document.getElementById('environmentFilter').value;
    const fromDate = document.getElementById('fromDate').value;
    const toDate = document.getElementById('toDate').value;
    
    const rows = document.querySelectorAll('#executionsTable tbody tr');
    let visibleCount = 0;
    let filterText = [];
    
    rows.forEach(row => {
        let show = true;
        
        // Status filter
        if (status && row.dataset.status !== status) {
            show = false;
        }
        
        // Environment filter
        if (environment && row.dataset.environment !== environment) {
            show = false;
        }
        
        // Date filter
        if (fromDate && row.dataset.date < fromDate) {
            show = false;
        }
        if (toDate && row.dataset.date > toDate) {
            show = false;
        }
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Build filter text
    if (status) filterText.push(`Status: ${status}`);
    if (environment) filterText.push(`Environment: ${environment}`);
    if (fromDate) filterText.push(`From: ${fromDate}`);
    if (toDate) filterText.push(`To: ${toDate}`);
    
    // Show filter summary
    if (filterText.length > 0) {
        document.getElementById('filterText').textContent = 
            `${filterText.join(', ')} (${visibleCount} results)`;
        document.getElementById('filterSummary').style.display = 'block';
    }
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('filterModal')).hide();
}

function clearFilters() {
    document.getElementById('filterForm').reset();
    document.querySelectorAll('#executionsTable tbody tr').forEach(row => {
        row.style.display = '';
    });
    document.getElementById('filterSummary').style.display = 'none';
}

function exportExecutions() {
    // Get visible rows
    const visibleRows = Array.from(document.querySelectorAll('#executionsTable tbody tr'))
        .filter(row => row.style.display !== 'none');
    
    if (visibleRows.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Create CSV content
    let csv = 'Execution ID,Test Case,Status,Executed By,Environment,Date,Duration\n';
    
    visibleRows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const data = [
            cells[0].textContent.trim(),
            cells[1].textContent.trim().replace(/\n/g, ' '),
            cells[2].textContent.trim(),
            cells[3].textContent.trim(),
            cells[4].textContent.trim(),
            cells[5].textContent.trim().replace(/\n/g, ' '),
            cells[6].textContent.trim()
        ];
        csv += data.map(field => `"${field}"`).join(',') + '\n';
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `test_executions_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    window.URL.revokeObjectURL(url);
}

function viewDetails(executionId) {
    // Simulate loading execution details
    const detailsContent = `
        <div class="row">
            <div class="col-md-6">
                <h6>Execution Information</h6>
                <p><strong>ID:</strong> EXE-${executionId}</p>
                <p><strong>Status:</strong> <span class="badge bg-success">Pass</span></p>
                <p><strong>Environment:</strong> Test Environment</p>
                <p><strong>Duration:</strong> 15 minutes</p>
            </div>
            <div class="col-md-6">
                <h6>Test Case Details</h6>
                <p><strong>Test Case:</strong> TC-${executionId}</p>
                <p><strong>Priority:</strong> High</p>
                <p><strong>Type:</strong> Manual</p>
                <p><strong>Executed By:</strong> Current User</p>
            </div>
        </div>
        <hr>
        <h6>Execution Results</h6>
        <p><strong>Expected Result:</strong> User should be able to login successfully</p>
        <p><strong>Actual Result:</strong> User logged in successfully with valid credentials</p>
        <h6>Comments</h6>
        <div class="border rounded p-3 bg-light">
            <p class="mb-1"><strong>Test executed successfully</strong></p>
            <small class="text-muted">Added on ${new Date().toLocaleDateString()}</small>
        </div>
    `;
    
    document.getElementById('detailsContent').innerHTML = detailsContent;
    new bootstrap.Modal(document.getElementById('detailsModal')).show();
}

function addComment(executionId) {
    document.getElementById('executionId').value = executionId;
    document.getElementById('commentText').value = '';
    new bootstrap.Modal(document.getElementById('commentModal')).show();
}

function saveComment() {
    const executionId = document.getElementById('executionId').value;
    const comment = document.getElementById('commentText').value;
    
    if (!comment.trim()) {
        alert('Please enter a comment');
        return;
    }
    
    // Simulate saving comment
    fetch('/api/add-execution-comment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            execution_id: executionId,
            comment: comment
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Comment added successfully');
            bootstrap.Modal.getInstance(document.getElementById('commentModal')).hide();
        } else {
            alert('Error adding comment: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Comment added successfully'); // Simulate success for demo
        bootstrap.Modal.getInstance(document.getElementById('commentModal')).hide();
    });
}

function createBug(executionId) {
    // Redirect to bug creation with pre-filled execution data
    window.location.href = `/bugs/create?execution_id=${executionId}`;
}

function deleteExecution(executionId) {
    if (confirm('Are you sure you want to delete this test execution? This action cannot be undone.')) {
        fetch(`/test-executions/${executionId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Test execution deleted successfully');
                location.reload();
            } else {
                alert('Error deleting test execution: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting test execution. Please try again.');
        });
    }
}
</script>
{% endblock %}
