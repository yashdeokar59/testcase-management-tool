{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 fw-bold text-dark mb-1">Settings</h1>
        <p class="text-muted">Configure your application preferences</p>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body">
                <div class="nav flex-column nav-pills" role="tablist">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#general" type="button">
                        <i class="fas fa-cog me-2"></i>General
                    </button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#notifications" type="button">
                        <i class="fas fa-bell me-2"></i>Notifications
                    </button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#security" type="button">
                        <i class="fas fa-shield-alt me-2"></i>Security
                    </button>
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#preferences" type="button">
                        <i class="fas fa-palette me-2"></i>Preferences
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="tab-content">
            <div class="tab-pane fade show active" id="general">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">General Settings</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_general_settings') }}">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Language</label>
                                    <select class="form-select" name="language">
                                        <option value="en" {% if current_user.language == 'en' %}selected{% endif %}>English</option>
                                        <option value="es" {% if current_user.language == 'es' %}selected{% endif %}>Spanish</option>
                                        <option value="fr" {% if current_user.language == 'fr' %}selected{% endif %}>French</option>
                                        <option value="de" {% if current_user.language == 'de' %}selected{% endif %}>German</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Timezone</label>
                                    <select class="form-select" name="timezone">
                                        <option value="UTC" {% if current_user.timezone == 'UTC' %}selected{% endif %}>UTC</option>
                                        <option value="EST" {% if current_user.timezone == 'EST' %}selected{% endif %}>EST</option>
                                        <option value="PST" {% if current_user.timezone == 'PST' %}selected{% endif %}>PST</option>
                                        <option value="GMT" {% if current_user.timezone == 'GMT' %}selected{% endif %}>GMT</option>
                                        <option value="IST" {% if current_user.timezone == 'IST' %}selected{% endif %}>IST</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Date Format</label>
                                    <select class="form-select" name="date_format">
                                        <option value="MM/DD/YYYY" {% if current_user.date_format == 'MM/DD/YYYY' %}selected{% endif %}>MM/DD/YYYY</option>
                                        <option value="DD/MM/YYYY" {% if current_user.date_format == 'DD/MM/YYYY' %}selected{% endif %}>DD/MM/YYYY</option>
                                        <option value="YYYY-MM-DD" {% if current_user.date_format == 'YYYY-MM-DD' %}selected{% endif %}>YYYY-MM-DD</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Items per Page</label>
                                    <select class="form-select" name="items_per_page">
                                        <option value="10" {% if current_user.items_per_page == 10 %}selected{% endif %}>10</option>
                                        <option value="25" {% if current_user.items_per_page == 25 %}selected{% endif %}>25</option>
                                        <option value="50" {% if current_user.items_per_page == 50 %}selected{% endif %}>50</option>
                                        <option value="100" {% if current_user.items_per_page == 100 %}selected{% endif %}>100</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mt-4">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="notifications">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Notification Settings</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_notification_settings') }}">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="emailNotifications" name="email_notifications" {% if current_user.email_notifications %}checked{% endif %}>
                                <label class="form-check-label" for="emailNotifications">
                                    <strong>Email Notifications</strong>
                                    <br><small class="text-muted">Receive notifications via email</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="testFailures" name="test_failure_alerts" {% if current_user.test_failure_alerts %}checked{% endif %}>
                                <label class="form-check-label" for="testFailures">
                                    <strong>Test Failure Alerts</strong>
                                    <br><small class="text-muted">Get notified when tests fail</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="assignments" name="assignment_notifications" {% if current_user.assignment_notifications %}checked{% endif %}>
                                <label class="form-check-label" for="assignments">
                                    <strong>Assignment Notifications</strong>
                                    <br><small class="text-muted">Receive notifications for new assignments</small>
                                </label>
                            </div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="bugUpdates" name="bug_update_notifications" {% if current_user.bug_update_notifications %}checked{% endif %}>
                                <label class="form-check-label" for="bugUpdates">
                                    <strong>Bug Status Updates</strong>
                                    <br><small class="text-muted">Get notified when bug status changes</small>
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Preferences
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="security">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Security Settings</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_security_settings') }}">
                            <div class="mb-3">
                                <label class="form-label">Current Password</label>
                                <input type="password" class="form-control" name="current_password" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" name="new_password" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Confirm New Password</label>
                                <input type="password" class="form-control" name="confirm_password" required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-key me-2"></i>Update Password
                            </button>
                        </form>
                        
                        <hr class="my-4">
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6>Two-Factor Authentication</h6>
                                <p class="text-muted mb-0">Add an extra layer of security to your account</p>
                            </div>
                            <div>
                                {% if current_user.two_factor_enabled %}
                                    <span class="badge bg-success me-2">Enabled</span>
                                    <form method="POST" action="{{ url_for('disable_2fa') }}" style="display: inline;">
                                        <button type="submit" class="btn btn-outline-danger btn-sm">Disable</button>
                                    </form>
                                {% else %}
                                    <span class="badge bg-secondary me-2">Disabled</span>
                                    <button class="btn btn-outline-primary btn-sm" onclick="enable2FAFromSettings()">Enable 2FA</button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="preferences">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Display Preferences</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_preferences') }}">
                            <div class="mb-3">
                                <label class="form-label">Theme</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="theme" id="lightTheme" value="light" {% if current_user.theme == 'light' %}checked{% endif %}>
                                    <label class="form-check-label" for="lightTheme">
                                        <i class="fas fa-sun me-2"></i>Light
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="theme" id="darkTheme" value="dark" {% if current_user.theme == 'dark' %}checked{% endif %}>
                                    <label class="form-check-label" for="darkTheme">
                                        <i class="fas fa-moon me-2"></i>Dark
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="theme" id="autoTheme" value="auto" {% if current_user.theme == 'auto' %}checked{% endif %}>
                                    <label class="form-check-label" for="autoTheme">
                                        <i class="fas fa-adjust me-2"></i>Auto
                                    </label>
                                </div>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="compactView" name="compact_view" {% if current_user.compact_view %}checked{% endif %}>
                                <label class="form-check-label" for="compactView">
                                    <strong>Compact View</strong>
                                    <br><small class="text-muted">Show more content in less space</small>
                                </label>
                            </div>
                            
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="animations" name="animations_enabled" {% if current_user.animations_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="animations">
                                    <strong>Enable Animations</strong>
                                    <br><small class="text-muted">Show smooth transitions and effects</small>
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Preferences
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function enable2FAFromSettings() {
    fetch('{{ url_for("enable_2fa") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Two-factor authentication has been enabled! Please check your profile page for the QR code.');
            location.reload();
        } else {
            alert('Error enabling 2FA: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while enabling 2FA.');
    });
}

// Form validation for password change
document.addEventListener('DOMContentLoaded', function() {
    const securityForm = document.querySelector('form[action="{{ url_for("update_security_settings") }}"]');
    if (securityForm) {
        securityForm.addEventListener('submit', function(e) {
            const newPassword = securityForm.querySelector('input[name="new_password"]').value;
            const confirmPassword = securityForm.querySelector('input[name="confirm_password"]').value;
            
            if (newPassword !== confirmPassword) {
                e.preventDefault();
                alert('New passwords do not match!');
                return false;
            }
            
            if (newPassword.length < 6) {
                e.preventDefault();
                alert('Password must be at least 6 characters long!');
                return false;
            }
        });
    }
    
    // Apply theme changes immediately
    const themeInputs = document.querySelectorAll('input[name="theme"]');
    themeInputs.forEach(input => {
        input.addEventListener('change', function() {
            if (this.value === 'dark') {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        });
    });
    
    // Apply compact view changes
    const compactViewInput = document.getElementById('compactView');
    if (compactViewInput) {
        compactViewInput.addEventListener('change', function() {
            if (this.checked) {
                document.body.classList.add('compact-view');
            } else {
                document.body.classList.remove('compact-view');
            }
        });
    }
    
    // Apply animation settings
    const animationsInput = document.getElementById('animations');
    if (animationsInput) {
        animationsInput.addEventListener('change', function() {
            if (!this.checked) {
                document.body.classList.add('no-animations');
            } else {
                document.body.classList.remove('no-animations');
            }
        });
    }
});
</script>
{% endblock %}
